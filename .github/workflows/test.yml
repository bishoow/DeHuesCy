name: Cypress E2E Automation

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '15 3 * * *'  # Runs at 9:00 AM Nepal time
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2] # Two parallel instances

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Create reports directory
        run: mkdir -p cypress/reports/html

      - name: Run Cypress Tests (Parallel)
        uses: cypress-io/github-action@v6
        with:
          start: npm start
          wait-on: 'http://localhost:3000'
          record: true
          parallel: true
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge Mochawesome JSON reports
        if: always()
        run: npx mochawesome-merge cypress/reports/html/*.json > cypress/reports/html/index.json

      - name: Generate final Mochawesome HTML report
        if: always()
        run: npx marge cypress/reports/html/index.json --reportDir cypress/reports/html --inline --charts

      - name: Verify generated report
        if: always()
        run: |
          echo "Generated report files:"
          ls -lh cypress/reports/html/
          head -n 20 cypress/reports/html/index.html || echo "No HTML content!"

      - name: Wait for report generation
        if: always()
        run: sleep 5

      - name: Send Email Report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_PASS }}
          subject: |
            Cypress Test Report â€“ De Heus Surveyor (Status: ${{ job.status }})
          to: proshore.qa.bootcamp@gmail.com
          from: De Heus QA Bot <proshore.qa.bootcamp@gmail.com>
          body: |
            Dear Team,

            The latest automated Cypress test execution for the De Heus Surveyor application has been completed successfully.
            Repository: ${{ github.repository }}
            Run Start Time: ${{ github.run_started_at }}
            Execution Status: ${{ job.status }}
            Please find the attached Mochawesome HTML test report containing detailed results, including screenshots and logs.

            Steps to View the Report:
              1. Download the attached file named index.html.
              2. Open it in any web browser (Chrome, Edge, or Firefox).
              3. View test summaries, details, screenshots, and logs.

            Best regards,  
            De Heus QA Automation Team
          attachments: cypress/reports/html/index.html
          secure: true
