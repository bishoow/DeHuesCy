name: Cypress E2E Automation

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '15 3 * * *'  # Runs at 9:00 AM Nepal time
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Create reports directory
        run: mkdir -p cypress/reports/html


      - name: Run Cypress Tests
        run: npx cypress run --reporter cypress-mochawesome-reporter

      - name: Merge Mochawesome JSON reports
        if: always()
        run: npx mochawesome-merge cypress/reports/html/*.json > cypress/reports/html/index.json

   
      - name: Generate final Mochawesome HTML report
        if: always()
        run: npx marge cypress/reports/html/index.json --reportDir cypress/reports/html --inline --charts

      - name: Verify generated report
        if: always()
        run: |
          echo "Generated report files:"
          ls -lh cypress/reports/html/
          echo "Preview first 20 lines of HTML file:"
          head -n 20 cypress/reports/html/index.html || echo "No HTML content!"

    
      - name: Wait for report generation
        if: always()
        run: sleep 5

      - name: Send Email Report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_PASS }}
          subject: |
            Cypress Test Report – De Heus Surveyor (Status: ${{ job.status }})
          to: proshore.qa.bootcamp@gmail.com
          from: De Heus QA Bot <proshore.qa.bootcamp@gmail.com>
          body: |
            Dear Team,

            The latest automated Cypress test execution for the De Heus Surveyor application has been completed successfully.
            Repository: ${{ github.repository }}
            Run Start Time: ${{ github.run_started_at }}
            Execution Status: ${{ job.status }}
            Please find the attached Mochawesome HTML test report containing detailed results, including screenshots and logs for reference.

            Steps to View the Report:

              1. Download the attached file named index.html.
              2. Locate the file in your system’s Downloads or chosen save folder.
              3. Open the file using your preferred web browser (such as Google Chrome, Microsoft Edge, or Firefox).
              4. The report will open in the browser, showing:
                 a.Test summaries and overall pass/fail status
                 b.Detailed test case information
                 c.Embedded screenshots and logs

                If you experience any issues viewing the report or have questions regarding the test results, please contact the QA Automation Team.

               Best regards,
               De Heus QA Automation Team
          attachments: cypress/reports/html/index.html
          secure: true
